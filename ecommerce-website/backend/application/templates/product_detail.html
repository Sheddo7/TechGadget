{% extends "base.html" %}

{% block title %}{{ product.name }} - TechGadgets{% endblock %}

{% block content %}
<div class="product-detail-page">
    <div class="container">
        <!-- Breadcrumb Navigation -->
        <nav class="breadcrumb">
            <a href="{{ url_for('index') }}" class="breadcrumb-item">Home</a>
            <span class="breadcrumb-separator">/</span>
            <a href="{{ url_for('products_page') }}" class="breadcrumb-item">Products</a>
            <span class="breadcrumb-separator">/</span>
            <a href="{{ url_for('category_page', slug=product.category_name|lower) }}" class="breadcrumb-item">{{ product.category_name }}</a>
            <span class="breadcrumb-separator">/</span>
            <span class="breadcrumb-item active">{{ product.name }}</span>
        </nav>

        <div class="product-detail">
            <div class="product-images">
                <div class="main-image">
                    <img src="{{ product.image_url }}" alt="{{ product.name }}" onerror="this.src='https://via.placeholder.com/600x400?text=No+Image'">
                </div>
            </div>

            <div class="product-info-detail">
                <div class="product-meta">
                    <span class="product-category">{{ product.category_name }}</span>
                    <div class="product-stock">{{ product.stock }} in stock</div>
                </div>

                <h1>{{ product.name }}</h1>

                <div class="average-rating">
                    <div class="rating-stars" data-rating="{{ product.average_rating }}">
                        <!-- Stars will be rendered by JavaScript -->
                    </div>
                    <span class="rating-value">{{ "%.1f"|format(product.average_rating) }}</span>
                    <span class="review-count">({{ product.review_count }} review{% if product.review_count != 1 %}s{% endif %})</span>
                </div>

                <p class="product-description">{{ product.description }}</p>

                <div class="product-price">${{ "%.2f"|format(product.price) }}</div>

                <div class="quantity-selector">
                    <label for="quantity">Quantity:</label>
                    <input type="number" id="quantity" name="quantity" value="1" min="1" max="{{ product.stock }}">
                </div>

                <div class="product-actions">
                    <button class="add-to-cart-btn cta-button"
                            data-product-id="{{ product.id }}"
                            data-product-name="{{ product.name }}"
                            data-product-price="{{ product.price }}"
                            data-product-image="{{ product.image_url }}">
                        ðŸ›’ Add to Cart
                    </button>
                </div>
            </div>
        </div>

        <!-- Reviews Section -->
        <div class="reviews-section">
            <h2>Customer Reviews</h2>

            <!-- Review Stats -->
            <div class="review-stats">
                <div class="overall-rating">
                    <div class="rating-value large">{{ "%.1f"|format(product.average_rating) }}</div>
                    <div class="rating-stars" data-rating="{{ product.average_rating }}">
                        <!-- Stars will be rendered by JavaScript -->
                    </div>
                    <div class="review-count">{{ product.review_count }} review{% if product.review_count != 1 %}s{% endif %}</div>
                </div>
            </div>

            <!-- Review Form (for authenticated users who haven't reviewed) -->
            {% if current_user.is_authenticated and not user_review %}
            <div class="review-form">
                <h3>Write a Review</h3>
                <form id="review-form" method="POST" action="{{ url_for('add_review', product_id=product.id) }}">
                    <div class="rating-input">
                        <label>Your Rating *</label>
                        <div class="star-rating">
                            <input type="radio" id="rating-5" name="rating" value="5">
                            <label for="rating-5">â˜…</label>
                            <input type="radio" id="rating-4" name="rating" value="4">
                            <label for="rating-4">â˜…</label>
                            <input type="radio" id="rating-3" name="rating" value="3">
                            <label for="rating-3">â˜…</label>
                            <input type="radio" id="rating-2" name="rating" value="2">
                            <label for="rating-2">â˜…</label>
                            <input type="radio" id="rating-1" name="rating" value="1">
                            <label for="rating-1">â˜…</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="review-title">Review Title *</label>
                        <input type="text" id="review-title" name="title" required maxlength="100">
                    </div>

                    <div class="form-group">
                        <label for="review-comment">Your Review *</label>
                        <textarea id="review-comment" name="comment" rows="5" required maxlength="1000"></textarea>
                    </div>

                    <button type="submit" class="auth-button">Submit Review</button>
                </form>
            </div>
            {% elif current_user.is_authenticated and user_review %}
            <div class="review-form">
                <h3>You've Already Reviewed This Product</h3>
                <p>Thank you for your review! You can only submit one review per product.</p>
            </div>
            {% else %}
            <div class="review-form">
                <h3>Write a Review</h3>
                <p>Please <a href="{{ url_for('login') }}">log in</a> to write a review for this product.</p>
            </div>
            {% endif %}

            <!-- Reviews List -->
            <div class="reviews-list">
                {% if reviews %}
                    {% for review in reviews %}
                    <div class="review-item">
                        <div class="review-header">
                            <div class="reviewer-info">
                                <div class="reviewer-name">{{ review.username }}</div>
                                <div class="review-date">{{ review.created_at.strftime('%B %d, %Y') }}</div>
                            </div>
                            <div class="rating-stars" data-rating="{{ review.rating }}">
                                <!-- Stars will be rendered by JavaScript -->
                            </div>
                        </div>
                        <h4 class="review-title">{{ review.title }}</h4>
                        <p class="review-comment">{{ review.comment }}</p>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="no-reviews">
                        <h3>No reviews yet</h3>
                        <p>Be the first to review this product!</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Related Products -->
        {% if related_products %}
        <div class="related-products">
            <h3>Related Products</h3>
            <div class="products-grid">
                {% for product in related_products %}
                <div class="product-card" data-category-id="{{ product.category_id }}">
                    <div class="product-image">
                        <img src="{{ product.image_url }}" alt="{{ product.name }}" onerror="this.src='https://via.placeholder.com/300x200?text=No+Image'">
                    </div>
                    <div class="product-info">
                        <div class="product-category">{{ product.category_name }}</div>
                        <h3 class="product-name">{{ product.name }}</h3>
                        <p class="product-description">{{ product.description[:100] }}{% if product.description|length > 100 %}...{% endif %}</p>
                        <div class="product-rating">
                            <div class="rating-stars" data-rating="{{ product.average_rating }}">
                                <!-- Stars will be rendered by JavaScript -->
                            </div>
                            <span class="review-count">({{ product.review_count }})</span>
                        </div>
                        <div class="product-price">${{ "%.2f"|format(product.price) }}</div>
                        <div class="product-stock">{{ product.stock }} in stock</div>
                        <button class="add-to-cart-btn"
                                data-product-id="{{ product.id }}"
                                data-product-name="{{ product.name }}"
                                data-product-price="{{ product.price }}"
                                data-product-image="{{ product.image_url }}">
                            ðŸ›’ Add to Cart
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}