{% extends "base.html" %}

{% block title %}Advanced Search - TechGadgets{% endblock %}

{% block content %}
<div class="advanced-search-page">
    <div class="container">
        <h1>üîç Advanced Search</h1>

        <!-- Search Form -->
        <div class="search-header">
            <form method="GET" action="{{ url_for('advanced_search') }}" class="advanced-search-form">
                <div class="search-box-large">
                    <input type="text"
                           name="q"
                           value="{{ search_query or '' }}"
                           placeholder="Search products, categories, descriptions..."
                           class="search-input-large"
                           id="advanced-search-input">
                    <button type="submit" class="search-btn-large">Search</button>
                </div>

                <!-- Quick Filters -->
                <div class="quick-filters-row">
                    <div class="filter-group">
                        <label>Category:</label>
                        <select name="category" class="filter-select" id="category-select">
                            <option value="">All Categories</option>
                            {% for category in categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="filter-group">
                        <label>Price Range:</label>
                        <div class="price-range">
                            <input type="number" name="min_price" placeholder="Min"
                                   value="{{ min_price or '' }}" step="0.01" min="0" id="min-price-input">
                            <span>to</span>
                            <input type="number" name="max_price" placeholder="Max"
                                   value="{{ max_price or '' }}" step="0.01" min="0" id="max-price-input">
                        </div>
                    </div>

                    <div class="filter-group">
                        <label class="checkbox-label">
                            <input type="checkbox" name="in_stock" id="in-stock-checkbox">
                            In Stock Only
                        </label>
                    </div>

                    <div class="filter-group">
                        <label>Sort By:</label>
                        <select name="sort_by" class="filter-select" id="sort-by-select">
                            <option value="name">Name</option>
                            <option value="price">Price</option>
                            <option value="rating">Rating</option>
                            <option value="date">Newest</option>
                            <option value="reviews">Most Reviews</option>
                        </select>
                        <select name="sort_order" class="filter-select" id="sort-order-select">
                            <option value="asc">Ascending</option>
                            <option value="desc">Descending</option>
                        </select>
                    </div>

                    <div class="filter-actions">
                        <button type="submit" class="apply-filters-btn">Apply Filters</button>
                        <a href="{{ url_for('advanced_search') }}" class="clear-filters-btn">Clear All</a>
                    </div>
                </div>
            </form>
        </div>

        <!-- Search Suggestions -->
        <div id="search-suggestions" class="search-suggestions"></div>

        <!-- Results -->
        <div class="search-results">
            <div class="results-header">
                <h2>Search Results ({{ products|length }} products)</h2>
                <div class="active-filters" id="active-filters">
                    {% if search_query %}
                    <div class="active-filter">
                        Search: "{{ search_query }}"
                        <button class="remove-filter" onclick="removeSearch()">√ó</button>
                    </div>
                    {% endif %}
                    {% if selected_category %}
                    {% for category in categories %}
                    {% if category.id == selected_category %}
                    <div class="active-filter">
                        Category: {{ category.name }}
                        <button class="remove-filter" onclick="removeCategory()">√ó</button>
                    </div>
                    {% endif %}
                    {% endfor %}
                    {% endif %}
                    {% if min_price or max_price %}
                    <div class="active-filter">
                        Price: ${{ "%.2f"|format(min_price) if min_price else "0" }} - ${{ "%.2f"|format(max_price) if max_price else "Any" }}
                        <button class="remove-filter" onclick="removePrice()">√ó</button>
                    </div>
                    {% endif %}
                    {% if in_stock %}
                    <div class="active-filter">
                        In Stock Only
                        <button class="remove-filter" onclick="removeStockFilter()">√ó</button>
                    </div>
                    {% endif %}
                </div>
            </div>

            {% if products %}
            <div class="products-grid">
                {% for product in products %}
                <div class="product-card">
                    <div class="product-image">
                        <img src="{{ product.image_url }}" alt="{{ product.name }}"
                             onerror="this.src='https://via.placeholder.com/300x200?text=No+Image'">
                    </div>
                    <div class="product-info">
                        <div class="product-category">{{ product.category_name }}</div>
                        <h3 class="product-name">{{ product.name }}</h3>
                        <p class="product-description">{{ product.description|truncate(100) }}</p>

                        <div class="product-rating">
                            <div class="rating-stars" data-rating="{{ product.average_rating }}">
                                <!-- Stars rendered by JavaScript -->
                            </div>
                            <span class="review-count">({{ product.review_count }})</span>
                        </div>

                        <div class="product-price">${{ "%.2f"|format(product.price) }}</div>
                        <div class="product-stock {% if product.stock > 0 %}in-stock{% else %}out-of-stock{% endif %}">
                            {{ product.stock }} in stock
                        </div>
                        <button class="add-to-cart-btn"
                                data-product-id="{{ product.id }}"
                                data-product-name="{{ product.name }}"
                                data-product-price="{{ product.price }}"
                                data-product-image="{{ product.image_url }}"
                                {% if product.stock == 0 %}disabled{% endif %}>
                            {% if product.stock > 0 %}üõí Add to Cart{% else %}Out of Stock{% endif %}
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="no-results">
                <h3>No products found</h3>
                <p>Try adjusting your search criteria or browse our <a href="{{ url_for('products_page') }}">all products</a>.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
.advanced-search-form {
    background: white;
    padding: 2rem;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
}

.search-box-large {
    display: flex;
    margin-bottom: 1.5rem;
}

.search-input-large {
    flex: 1;
    padding: 1rem;
    border: 2px solid #3498db;
    border-radius: 25px 0 0 25px;
    font-size: 1.1rem;
    border-right: none;
}

.search-btn-large {
    background: #3498db;
    color: white;
    border: 2px solid #3498db;
    padding: 1rem 2rem;
    border-radius: 0 25px 25px 0;
    cursor: pointer;
    font-size: 1.1rem;
}

.quick-filters-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    align-items: end;
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.filter-group label {
    font-weight: bold;
    color: #2c3e50;
    margin-bottom: 0.3rem;
}

.filter-select {
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 5px;
}

.price-range {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.price-range input {
    width: 80px;
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 5px;
}

.checkbox-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: normal;
    cursor: pointer;
}

.filter-actions {
    display: flex;
    gap: 1rem;
    align-items: end;
}

.apply-filters-btn {
    background: #27ae60;
    color: white;
    border: none;
    padding: 0.8rem 1.5rem;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
}

.clear-filters-btn {
    background: #95a5a6;
    color: white;
    padding: 0.8rem 1.5rem;
    border-radius: 5px;
    text-decoration: none;
    font-weight: bold;
}

.search-suggestions {
    position: absolute;
    background: white;
    border: 1px solid #ddd;
    border-radius: 5px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    width: calc(100% - 4rem);
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.suggestion-item {
    padding: 0.8rem 1rem;
    cursor: pointer;
    border-bottom: 1px solid #ecf0f1;
}

.suggestion-item:hover {
    background: #f8f9fa;
}

.suggestion-item:last-child {
    border-bottom: none;
}

.results-header {
    margin-bottom: 2rem;
}

.active-filters {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-top: 1rem;
}

.active-filter {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: #3498db;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.9rem;
}

.remove-filter {
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    font-weight: bold;
}

.no-results {
    text-align: center;
    padding: 4rem 2rem;
    color: #7f8c8d;
}

.product-stock.out-of-stock {
    color: #e74c3c;
}

.product-stock.in-stock {
    color: #27ae60;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize form values from URL parameters
    const urlParams = new URLSearchParams(window.location.search);

    // Set category
    const categoryId = urlParams.get('category');
    const categorySelect = document.getElementById('category-select');
    if (categorySelect && categoryId) {
        categorySelect.value = categoryId;
    }

    // Set in stock checkbox
    const inStock = urlParams.get('in_stock');
    const inStockCheckbox = document.getElementById('in-stock-checkbox');
    if (inStockCheckbox && inStock === 'true') {
        inStockCheckbox.checked = true;
    }

    // Set sort options
    const sortBy = urlParams.get('sort_by') || 'name';
    const sortOrder = urlParams.get('sort_order') || 'asc';
    const sortBySelect = document.getElementById('sort-by-select');
    const sortOrderSelect = document.getElementById('sort-order-select');

    if (sortBySelect) {
        sortBySelect.value = sortBy;
    }
    if (sortOrderSelect) {
        sortOrderSelect.value = sortOrder;
    }

    // Search suggestions
    const searchInput = document.getElementById('advanced-search-input');
    const suggestionsContainer = document.getElementById('search-suggestions');

    if (searchInput) {
        let searchTimeout;

        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const query = this.value.trim();

            if (query.length < 2) {
                suggestionsContainer.innerHTML = '';
                suggestionsContainer.style.display = 'none';
                return;
            }

            searchTimeout = setTimeout(() => {
                fetchSearchSuggestions(query);
            }, 300);
        });

        searchInput.addEventListener('focus', function() {
            const query = this.value.trim();
            if (query.length >= 2 && suggestionsContainer.innerHTML) {
                suggestionsContainer.style.display = 'block';
            }
        });

        // Hide suggestions when clicking outside
        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !suggestionsContainer.contains(e.target)) {
                suggestionsContainer.style.display = 'none';
            }
        });
    }
});

function fetchSearchSuggestions(query) {
    fetch(`/api/search/suggestions?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(suggestions => {
            const container = document.getElementById('search-suggestions');
            container.innerHTML = '';

            if (suggestions.length > 0) {
                suggestions.forEach(suggestion => {
                    const item = document.createElement('div');
                    item.className = 'suggestion-item';
                    item.textContent = suggestion.display_text;
                    item.addEventListener('click', function() {
                        document.getElementById('advanced-search-input').value = suggestion.product_name;
                        container.style.display = 'none';
                        window.location.href = `/product/${suggestion.product_id}`;
                    });
                    container.appendChild(item);
                });
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Error fetching suggestions:', error);
        });
}

function removeSearch() {
    const url = new URL(window.location);
    url.searchParams.delete('q');
    window.location.href = url.toString();
}

function removeCategory() {
    const url = new URL(window.location);
    url.searchParams.delete('category');
    window.location.href = url.toString();
}

function removePrice() {
    const url = new URL(window.location);
    url.searchParams.delete('min_price');
    url.searchParams.delete('max_price');
    window.location.href = url.toString();
}

function removeStockFilter() {
    const url = new URL(window.location);
    url.searchParams.delete('in_stock');
    window.location.href = url.toString();
}
</script>
{% endblock %}