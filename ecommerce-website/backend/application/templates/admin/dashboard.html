{% extends "admin/base.html" %}

{% block title %}Admin Dashboard - TechGadgets{% endblock %}
{% block page_title %}Dashboard Overview{% endblock %}

{% block content %}
<div class="dashboard">
    <!-- Stats Grid -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value">{{ total_products }}</div>
            <div class="stat-label">Total Products</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ total_orders }}</div>
            <div class="stat-label">Total Orders</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ total_users }}</div>
            <div class="stat-label">Total Users</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">${{ "%.2f"|format(total_revenue) }}</div>
            <div class="stat-label">Total Revenue</div>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
        <!-- Recent Orders -->
        <div class="data-table">
            <div style="padding: 1rem; border-bottom: 1px solid #ecf0f1; background: #34495e; color: white;">
                <h3 style="margin: 0;">Recent Orders</h3>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Order #</th>
                        <th>Customer</th>
                        <th>Amount</th>
                        <th>Status</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in recent_orders %}
                    <tr>
                        <td>
                            <a href="{{ url_for('admin_order_detail', order_id=order.id) }}">
                                {{ order.order_number }}
                            </a>
                        </td>
                        <td>{{ order.username }}</td>
                        <td>${{ "%.2f"|format(order.total_amount) }}</td>
                        <td>
                            <span class="status-badge status-{{ order.status }}">
                                {{ order.status|title }}
                            </span>
                        </td>
                        <td>{{ order.created_at[:10] }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div style="padding: 1rem; text-align: center; border-top: 1px solid #ecf0f1;">
                <a href="{{ url_for('admin_orders') }}" class="btn primary">View All Orders</a>
            </div>
        </div>

        <!-- Low Stock -->
        <div class="data-table">
            <div style="padding: 1rem; border-bottom: 1px solid #ecf0f1; background: #e74c3c; color: white;">
                <h3 style="margin: 0;">Low Stock Alert</h3>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Stock</th>
                    </tr>
                </thead>
                <tbody>
                    {% for product in low_stock_products %}
                    <tr>
                        <td>{{ product.name }}</td>
                        <td>
                            <span style="color: #e74c3c; font-weight: bold;">
                                {{ product.stock }}
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                    {% if not low_stock_products %}
                    <tr>
                        <td colspan="2" style="text-align: center; color: #7f8c8d; padding: 2rem;">
                            No low stock products
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
            <div style="padding: 1rem; text-align: center; border-top: 1px solid #ecf0f1;">
                <a href="{{ url_for('admin_products') }}" class="btn primary">Manage Products</a>
            </div>
        </div>
    </div>

    <!-- Sales Chart -->
    <div class="data-table" style="margin-top: 2rem;">
        <div style="padding: 1rem; border-bottom: 1px solid #ecf0f1; background: #34495e; color: white;">
            <h3 style="margin: 0;">Sales Last 30 Days</h3>
        </div>
        <div style="padding: 2rem;">
            {% if sales_data %}
            <!-- Simple bar chart using CSS classes -->
            <div style="display: flex; align-items: end; gap: 0.5rem; height: 200px; border-bottom: 1px solid #ecf0f1; padding-bottom: 1rem;">
                {% for day in sales_data %}
                <div style="display: flex; flex-direction: column; align-items: center; flex: 1;">
                    <div class="chart-bar" data-revenue="{{ day.revenue or 0 }}"></div>
                    <div style="font-size: 0.7rem; margin-top: 0.5rem; color: #7f8c8d;">
                        {{ day.date[-5:] }}
                    </div>
                </div>
                {% endfor %}
            </div>
            <div style="display: flex; justify-content: space-around; margin-top: 1rem;">
                <div style="text-align: center;">
                    <div style="font-weight: bold; color: #2c3e50;">Total Orders</div>
                    <div>{{ sales_data|sum(attribute='order_count') }}</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-weight: bold; color: #2c3e50;">Total Revenue</div>
                    <div>${{ "%.2f"|format(sales_data|sum(attribute='revenue')) }}</div>
                </div>
            </div>
            {% else %}
            <div style="text-align: center; color: #7f8c8d; padding: 3rem;">
                No sales data available
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
.chart-bar {
    background: #3498db;
    width: 30px;
    border-radius: 3px 3px 0 0;
    min-height: 1px;
}
</style>

<script>
// Set bar heights using JavaScript
document.addEventListener('DOMContentLoaded', function() {
    const bars = document.querySelectorAll('.chart-bar');
    bars.forEach(bar => {
        const revenue = parseFloat(bar.getAttribute('data-revenue')) || 0;
        // Scale the height - adjust the divisor as needed for proper visualization
        const height = Math.max(1, revenue / 50);
        bar.style.height = height + 'px';
    });
});
</script>
{% endblock %}